<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PennyPilot — Budget & Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1f2937" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%231F2937'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-family='SF Pro,Inter,Arial' font-size='120' fill='%23A7F3D0'%3E%24%3C/text%3E%3Ctext x='50%25' y='78%25' dominant-baseline='middle' text-anchor='middle' font-family='SF Pro,Inter,Arial' font-size='28' fill='white'%3EPennyPilot%3C/text%3E%3C/svg%3E" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%231F2937'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-family='SF Pro,Inter,Arial' font-size='120' fill='%23A7F3D0'%3E%24%3C/text%3E%3Ctext x='50%25' y='78%25' dominant-baseline='middle' text-anchor='middle' font-family='SF Pro,Inter,Arial' font-size='28' fill='white'%3EPennyPilot%3C/text%3E%3C/svg%3E" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      --bg:#0b1220;          /* page background */
      --card:#111827;        /* card background */
      --ink:#e5e7eb;         /* main text */
      --ink-dim:#9ca3af;     /* secondary text */
      --accent:#34d399;      /* green */
      --warn:#f59e0b;        /* amber */
      --danger:#ef4444;      /* red */
      --muted:#1f2937;       /* borders */
      --ring:#10b981;        /* success ring */
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 80% -10%, #0f1a2c, #0b1220 55%) fixed;
      color:var(--ink);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, "SF Pro Text", Arial, sans-serif;
      padding-bottom: 80px; /* room for nav */
    }
    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(11,18,32,.9), rgba(11,18,32,.7), rgba(11,18,32,0));
      backdrop-filter: blur(8px);
      padding: 16px clamp(16px, 4vw, 24px) 6px;
    }
    .title{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:38px; height:38px; border-radius:10px;
      background:#1f2937; display:grid; place-items:center;
      box-shadow:var(--shadow);
      font-weight:700; color:#a7f3d0;
    }
    h1{font-size:20px; margin:0 0 4px}
    .subtitle{color:var(--ink-dim); font-size:14px}
    .grid{
      display:grid; gap:16px; padding: 6px clamp(16px, 4vw, 24px) 24px;
      grid-template-columns: 1fr;
      max-width: 980px; margin: 0 auto;
    }
    .card{
      background: linear-gradient(180deg, #0f172a, #0d1526);
      border: 1px solid #162036;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .row{display:flex; flex-wrap:wrap; gap:12px}
    label{font-size:12px; color:var(--ink-dim); display:block; margin-bottom:6px}
    input, select, textarea{
      width:100%; color:var(--ink); background:#0a1324; border:1px solid #1c2740; border-radius:12px;
      padding:12px 14px; outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:#275999; box-shadow:0 0 0 2px #1e3a8a33}
    .btn{
      appearance: none; border:0; border-radius:12px;
      padding:12px 16px; background:linear-gradient(180deg, #34d399, #10b981); color:#062016;
      font-weight:700; box-shadow: 0 6px 18px rgba(16,185,129,.35); cursor:pointer;
    }
    .btn.secondary{background:linear-gradient(180deg, #22324f, #16233b); color:#e5e7eb; box-shadow:none; border:1px solid #2a3b5d}
    .btn.warn{background:linear-gradient(180deg, #f59e0b, #d97706); color:#261800; box-shadow:0 6px 18px rgba(245,158,11,.35)}
    .btn.danger{background:linear-gradient(180deg, #ef4444, #dc2626); color:#2b0000}
    .kpis{display:grid; grid-template-columns: repeat(3,1fr); gap:12px}
    .kpi{background:#0a1324; border:1px solid #1c2740; border-radius:14px; padding:12px}
    .kpi .v{font-size:22px; font-weight:800}
    .ring{
      --pct:0;
      width:84px; height:84px; border-radius:50%; background:
        conic-gradient(var(--ring) calc(var(--pct)*1%), #1f2937 0);
      display:grid; place-items:center;
      box-shadow: inset 0 0 0 9px #0a1324, 0 8px 24px rgba(0,0,0,.25);
    }
    .ring > span{font-weight:800}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{padding:10px 8px; border-bottom:1px solid #1b2540}
    .table th{color:#93a3bf; font-weight:600; text-align:left; font-size:12px}
    .pill{
      padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #2a3b5d; background:#0a1324;
    }
    .pill.ok{color:#34d399; border-color:#1e8d6c}
    .pill.warn{color:#f59e0b; border-color:#9a6a0d}
    .pill.over{color:#ef4444; border-color:#a32020}
    nav{
      position: fixed; left:0; right:0; bottom:0; z-index:20;
      display:grid; grid-template-columns: repeat(4,1fr);
      background: rgba(13,21,38,.7); backdrop-filter: blur(10px);
      border-top:1px solid #1b2540;
    }
    nav button{
      background:none; border:0; padding:10px 6px; color:#c7d2fe;
      display:grid; place-items:center; gap:4px; font-size:12px
    }
    nav button[aria-current="page"]{color:#34d399; font-weight:700}
    .hidden{display:none !important}
    .note{color:#9ca3af; font-size:13px}
    .danger-zone{border-top:1px dashed #2b3b66; margin-top:10px; padding-top:10px}
    /* mobile-friendly keypad alignment */
    .amount-input{font-size:22px; letter-spacing:.5px}
    .toast{
      position: fixed; left:50%; bottom:92px; transform: translateX(-50%);
      background:#0b1a2f; border:1px solid #1c2740; color:#e5e7eb; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
      z-index:100; opacity:0; pointer-events:none; transition:.25s;
    }
    .toast.show{opacity:1}
    @media (min-width: 820px){
      .grid{grid-template-columns: 1.2fr .8fr}
      .kpis{grid-template-columns: repeat(4,1fr)}
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <div class="logo">$</div>
    <div>
      <h1>PennyPilot</h1>
      <div class="subtitle">Fast logging • Simple budgets • On-device & offline</div>
    </div>
  </div>
</header>

<main class="grid">
  <!-- Left column -->
  <section class="card" id="home">
    <h2 style="margin-top:0">Today</h2>
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="l">Spent today</div><div class="v" id="kpiToday">$0.00</div></div>
      <div class="kpi"><div class="l">This month</div><div class="v" id="kpiMonth">$0.00</div></div>
      <div class="kpi"><div class="l">Under/Over</div><div class="v" id="kpiDelta">$0.00</div></div>
    </div>

    <div style="display:flex; gap:14px; align-items:center; margin-top:14px">
      <div class="ring"><span id="ringPct">0%</span></div>
      <div>
        <div class="subtitle">Overall month progress</div>
        <div class="note">Based on total budget you set under <b>Budgets</b>.</div>
      </div>
    </div>
  </section>

  <section class="card" id="quickLog">
    <h2 style="margin-top:0">Quick Log</h2>
    <div class="row">
      <div style="flex:1 1 140px">
        <label for="amount">Amount</label>
        <input id="amount" inputmode="decimal" class="amount-input" placeholder="e.g., 12.50" />
      </div>
      <div style="flex:1 1 160px">
        <label for="category">Category</label>
        <select id="category"></select>
      </div>
      <div style="flex:1 1 160px">
        <label for="date">Date</label>
        <input id="date" type="date" />
      </div>
    </div>
    <div class="row">
      <div style="flex:1 1 100%">
        <label for="note">Note (optional)</label>
        <input id="note" placeholder="coffee, bus, groceries…" />
      </div>
    </div>
    <div class="row">
      <button class="btn" id="saveTx">Save Expense</button>
      <button class="btn secondary" id="addFav">★ Save as Favorite</button>
      <button class="btn secondary" id="useFav">Use Favorite</button>
    </div>
  </section>

  <!-- Right column -->
  <section class="card" id="budgets">
    <h2 style="margin-top:0">Budgets</h2>
    <table class="table" id="budgetTable">
      <thead>
        <tr><th>Category</th><th>Budget</th><th>Spent</th><th>%</th><th>Status</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:10px">
      <input id="newCat" placeholder="New category name (optional emoji)" style="flex:2 1 220px" />
      <input id="newCatBudget" inputmode="decimal" placeholder="Budget" style="flex:1 1 120px" />
      <button class="btn" id="addCat">Add/Update</button>
    </div>
    <div class="danger-zone">
      <button class="btn warn" id="resetBudgets">Reset to Starter Categories</button>
    </div>
  </section>

  <section class="card" id="reports">
    <h2 style="margin-top:0">Reports</h2>
    <div class="row">
      <div class="kpi" style="flex:1 1 180px">
        <div class="l">Month</div>
        <input type="month" id="filterMonth" />
      </div>
      <div class="kpi" style="flex:1 1 180px">
        <div class="l">Export</div>
        <div class="row">
          <button class="btn secondary" id="exportCsv">CSV</button>
          <button class="btn secondary" id="exportJson">JSON</button>
          <button class="btn secondary" id="importJsonBtn">Import</button>
          <input id="importJson" type="file" accept="application/json" class="hidden" />
        </div>
        <div class="note">Backup/restore lives on your device.</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <canvas id="donut" height="220"></canvas>
      <canvas id="trend" height="220"></canvas>
    </div>

    <h3 style="margin:10px 0 0">Transactions (month)</h3>
    <table class="table" id="txTable">
      <thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Note</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card" id="settings">
    <h2 style="margin-top:0">Settings</h2>
    <div class="row">
      <div class="kpi" style="flex: 1 1 220px">
        <div class="l">Currency</div>
        <input id="currency" placeholder="$, €, £, ₹…" maxlength="3" />
      </div>
      <div class="kpi" style="flex: 1 1 220px">
        <div class="l">App Lock (optional)</div>
        <input id="pin" type="password" inputmode="numeric" placeholder="4–8 digits" />
        <button class="btn secondary" id="savePin" style="margin-top:8px">Set/Change PIN</button>
        <div class="note">Lock is local to this device. If set, app asks for PIN at launch.</div>
      </div>
    </div>
    <div class="danger-zone">
      <button class="btn danger" id="wipeData">Erase All Local Data</button>
    </div>
    <p class="note">PennyPilot stores data in <b>localStorage</b> on this device only. No servers, no tracking, zero cost.</p>
  </section>
</main>

<nav>
  <button data-view="home" aria-current="page">Home</button>
  <button data-view="quickLog">Log</button>
  <button data-view="budgets">Budgets</button>
  <button data-view="reports">Reports</button>
  <button data-view="settings">Settings</button>
</nav>

<div class="toast" id="toast">Saved</div>

<script>
/* =========================
   Storage & Defaults
   ========================= */
const LS = {
  tx: 'pp_tx_v1',
  cats: 'pp_cats_v1',
  cfg: 'pp_cfg_v1',
  pin: 'pp_pin_v1'
};

const starterCategories = [
  { name: 'Groceries 🍎', budget: 300 },
  { name: 'Dining 🍽', budget: 150 },
  { name: 'Transport 🚗', budget: 120 },
  { name: 'Housing 🏠', budget: 800 },
  { name: 'Utilities 💡', budget: 100 },
  { name: 'Health 🏥', budget: 60 },
  { name: 'Entertainment 🎮', budget: 80 },
  { name: 'Misc 💸', budget: 90 },
];

function load(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : (fallback ?? null);
  }catch(e){ return fallback ?? null }
}
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function currencySymbol(){
  const cfg = load(LS.cfg,{currency:"$"});
  return (cfg.currency || "$").trim() || "$";
}
function fmt(n){ return currencySymbol() + Number(n||0).toFixed(2); }
function todayStr(){
  const d = new Date(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
  return `${d.getFullYear()}-${m}-${dd}`;
}
function monthKey(date){ const d = new Date(date); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

if(!load(LS.cats)) save(LS.cats, starterCategories);
if(!load(LS.tx)) save(LS.tx, []);
if(!load(LS.cfg)) save(LS.cfg, {currency:"$", fav:null});

/* =========================
   Views / Navigation
   ========================= */
const views = ['home','quickLog','budgets','reports','settings'];
const navButtons = [...document.querySelectorAll('nav button')];
function show(view){
  views.forEach(v=>document.getElementById(v).classList.toggle('hidden', v!==view));
  navButtons.forEach(b=>b.setAttribute('aria-current', b.dataset.view===view ? 'page':'false'));
  if(view==='home' || view==='budgets' || view==='reports') refreshAll();
  window.scrollTo({top:0, behavior:'smooth'});
}
navButtons.forEach(b=>b.addEventListener('click',()=>show(b.dataset.view)));
show('home');

/* =========================
   PIN (optional lock)
   ========================= */
async function hashPIN(pin){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode('PENNY'+pin));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function checkLockOnLoad(){
  const pinHash = load(LS.pin);
  if(!pinHash) return;
  let attempts = 0;
  while(attempts<5){
    const pin = prompt('Enter PIN to unlock:');
    if(pin===null) break;
    const hash = await hashPIN(pin);
    if(hash===pinHash){ toast('Unlocked'); return; }
    attempts++; alert('Wrong PIN. Try again.');
  }
  document.body.innerHTML = '<div style="padding:24px">Locked. Reload to try again.</div>';
}
checkLockOnLoad();

/* =========================
   Quick Log
   ========================= */
const amount = document.getElementById('amount');
const category = document.getElementById('category');
const dateInput = document.getElementById('date');
const note = document.getElementById('note');
const saveTxBtn = document.getElementById('saveTx');
const addFavBtn = document.getElementById('addFav');
const useFavBtn = document.getElementById('useFav');

dateInput.value = todayStr();

function refreshCategoriesSelect(){
  const cats = load(LS.cats, []);
  category.innerHTML = cats.map(c=>`<option>${escapeHtml(c.name)}</option>`).join('');
}
refreshCategoriesSelect();

saveTxBtn.addEventListener('click', ()=>{
  const amt = parseFloat(String(amount.value).replace(',','.'));
  const cat = category.value;
  const dt = dateInput.value || todayStr();
  if(!(amt>0)){ toast('Enter a positive amount', true); return; }
  if(!cat){ toast('Select a category', true); return; }
  const tx = load(LS.tx, []);
  tx.push({id:crypto.randomUUID(), amount: +amt.toFixed(2), category: cat, date: dt, note: note.value?.trim()||''});
  save(LS.tx, tx);
  amount.value = ''; note.value='';
  toast('Saved ✅');
  refreshAll();
});

addFavBtn.addEventListener('click', ()=>{
  const fav = {
    amount: amount.value || '',
    category: category.value || '',
    note: note.value || ''
  };
  const cfg = load(LS.cfg,{});
  cfg.fav = fav; save(LS.cfg, cfg);
  toast('Favorite saved ★');
});
useFavBtn.addEventListener('click', ()=>{
  const fav = load(LS.cfg,{fav:null}).fav;
  if(!fav){ toast('No favorite yet', true); return; }
  if(fav.amount) amount.value = fav.amount;
  if(fav.category){
    [...category.options].forEach((o,i)=>{ if(o.value===fav.category) category.selectedIndex=i; });
  }
  if(fav.note) note.value = fav.note;
  toast('Favorite applied');
});

/* =========================
   Budgets
   ========================= */
const budgetTableBody = document.querySelector('#budgetTable tbody');
const newCat = document.getElementById('newCat');
const newCatBudget = document.getElementById('newCatBudget');
document.getElementById('addCat').addEventListener('click', ()=>{
  const name = (newCat.value||'').trim(); const b = parseFloat(String(newCatBudget.value).replace(',','.'));
  if(!name || !(b>=0)){ toast('Enter name & budget', true); return; }
  const cats = load(LS.cats, []);
  const idx = cats.findIndex(c=>c.name.toLowerCase()===name.toLowerCase());
  if(idx>=0){ cats[idx].budget = +b.toFixed(2); } else { cats.push({name, budget:+b.toFixed(2)}); }
  save(LS.cats, cats); refreshAll(); newCat.value=''; newCatBudget.value='';
  toast('Budget updated');
});
document.getElementById('resetBudgets').addEventListener('click', ()=>{
  if(confirm('Reset categories to starter set? This keeps your transactions.')){ save(LS.cats, starterCategories); refreshAll(); }
});

function budgetStats(monthKeySel){
  const cats = load(LS.cats, []);
  const tx = load(LS.tx, []);
  const thisMonthTx = tx.filter(t=>monthKey(t.date)===monthKeySel);
  const spentByCat = Object.fromEntries(cats.map(c=>[c.name,0]));
  thisMonthTx.forEach(t=> spentByCat[t.category] = (spentByCat[t.category]||0) + t.amount);
  const rows = cats.map(c=>{
    const spent = +(spentByCat[c.name]||0).toFixed(2);
    const pct = c.budget>0 ? spent/c.budget : 0;
    const status = c.budget===0 ? 'No budget' : (pct<0.75?'OK':(pct<=1?'Warning':'Over'));
    return {category:c.name, budget:c.budget, spent, pct, status};
  });
  const totals = rows.reduce((a,r)=>({budget:a.budget+r.budget, spent:a.spent+r.spent}), {budget:0,spent:0});
  return {rows, totals};
}

function renderBudgets(){
  const mk = document.getElementById('filterMonth').value || monthKey(new Date());
  const {rows, totals} = budgetStats(mk);
  budgetTableBody.innerHTML = rows.map(r=>{
    const pct=(r.budget>0)?(r.spent/r.budget):0;
    const pillClass = r.status==='OK'?'ok':(r.status==='Warning'?'warn':(r.status==='Over'?'over':'')); 
    return `<tr>
      <td>${escapeHtml(r.category)}</td>
      <td>${fmt(r.budget)}</td>
      <td>${fmt(r.spent)}</td>
      <td>${(r.budget>0?(pct*100):0).toFixed(0)}%</td>
      <td><span class="pill ${pillClass}">${r.status}</span></td>
      <td><button class="btn secondary" data-del="${escapeAttr(r.category)}">Delete</button></td>
    </tr>`;
  }).join('');
  budgetTableBody.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const name = btn.getAttribute('data-del');
      if(confirm(`Delete category "${name}"? Transactions remain; you can re-create the category later.`)){
        let cats = load(LS.cats, []); cats = cats.filter(c=>c.name!==name); save(LS.cats, cats); refreshAll();
      }
    });
  });

  // KPIs + ring
  const delta = totals.budget - totals.spent;
  document.getElementById('kpiMonth').textContent = fmt(totals.spent);
  document.getElementById('kpiDelta').textContent = (delta>=0?'+':'-') + fmt(Math.abs(delta));
  const pct = totals.budget>0 ? Math.min(1, totals.spent/totals.budget) : 0;
  document.querySelector('.ring').style.setProperty('--pct', (pct*100).toFixed(1));
  document.getElementById('ringPct').textContent = `${Math.round(pct*100)}%`;
}

/* =========================
   Reports (charts + table)
   ========================= */
const donutEl = document.getElementById('donut');
const trendEl = document.getElementById('trend');
let donutChart, trendChart;

function renderReports(){
  const mk = document.getElementById('filterMonth').value || monthKey(new Date());
  const tx = load(LS.tx, []).filter(t=>monthKey(t.date)===mk);
  // KPIs
  const todayTotal = load(LS.tx, []).filter(t=>t.date===todayStr()).reduce((a,b)=>a+b.amount,0);
  document.getElementById('kpiToday').textContent = fmt(todayTotal);

  // Table
  const tbody = document.querySelector('#txTable tbody');
  tbody.innerHTML = tx.sort((a,b)=>a.date<b.date?1:-1).map(t=>`
    <tr>
      <td>${t.date}</td>
      <td>${escapeHtml(t.category)}</td>
      <td>${fmt(t.amount)}</td>
      <td>${escapeHtml(t.note||'')}</td>
      <td><button class="btn secondary" data-delete="${t.id}">Delete</button></td>
    </tr>
  `).join('');
  tbody.querySelectorAll('button[data-delete]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-delete');
      const arr = load(LS.tx, []).filter(x=>x.id!==id);
      save(LS.tx, arr); refreshAll(); toast('Deleted');
    });
  });

  // Donut by category
  const cats = load(LS.cats, []).map(c=>c.name);
  const sums = cats.map(c=> tx.filter(t=>t.category===c).reduce((a,b)=>a+b.amount,0));
  donutChart?.destroy();
  donutChart = new Chart(donutEl, {
    type:'doughnut',
    data:{
      labels: cats,
      datasets:[{ data:sums, backgroundColor: palette(cats.length) }]
    },
    options:{ plugins:{ legend:{ position:'bottom', labels:{ color:'#cbd5e1' } } } }
  });

  // 6-month trend
  const allTx = load(LS.tx, []);
  const months = lastMonthsLabels(6);
  const totals = months.map(m => allTx.filter(t=>monthKey(t.date)===m).reduce((a,b)=>a+b.amount,0));
  trendChart?.destroy();
  trendChart = new Chart(trendEl, {
    type:'line',
    data:{ labels: months, datasets:[{ label:'Spend', data: totals, borderColor:'#34d399', backgroundColor:'#10b98122', tension:.25, fill:true }] },
    options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#9ca3af' } }, y:{ ticks:{ color:'#9ca3af' } } } }
  });
}

function palette(n){
  const base = ['#34d399','#60a5fa','#f472b6','#f59e0b','#a78bfa','#f87171','#22d3ee','#facc15','#4ade80','#fb7185'];
  const arr=[]; for(let i=0;i<n;i++) arr.push(base[i%base.length]);
  return arr;
}
function lastMonthsLabels(n){
  const res=[]; const d=new Date();
  for(let i=n-1;i>=0;i--){
    const x=new Date(d.getFullYear(), d.getMonth()-i, 1);
    res.push(`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}`);
  }
  return res;
}

/* =========================
   Exports / Imports
   ========================= */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  const tx = load(LS.tx, []);
  const rows = [['id','date','category','amount','note']].concat(
    tx.map(t=>[t.id,t.date,t.category,t.amount, (t.note||'').replace(/"/g,'""') ])
  );
  const csv = rows.map(r=>r.map(c=>`"${String(c)}"`).join(',')).join('\n');
  download(`pennypilot-${Date.now()}.csv`, 'text/csv', csv);
});
document.getElementById('exportJson').addEventListener('click', ()=>{
  download(`pennypilot-${Date.now()}.json`, 'application/json', JSON.stringify(load(LS.tx, [])));
});
const importJsonInput = document.getElementById('importJson');
document.getElementById('importJsonBtn').addEventListener('click', ()=> importJsonInput.click());
importJsonInput.addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  try{
    const arr = JSON.parse(text); if(!Array.isArray(arr)) throw new Error();
    save(LS.tx, arr); refreshAll(); toast('Imported');
  }catch{ toast('Invalid JSON', true); }
});

/* =========================
   Settings
   ========================= */
document.getElementById('currency').value = load(LS.cfg,{currency:"$"}).currency || "$";
document.getElementById('currency').addEventListener('input', e=>{
  const cfg = load(LS.cfg,{currency:"$"}); cfg.currency = e.target.value.slice(0,3);
  save(LS.cfg, cfg); refreshAll();
});
document.getElementById('savePin').addEventListener('click', async ()=>{
  const pin = document.getElementById('pin').value.trim();
  if(pin && !/^\d{4,8}$/.test(pin)){ toast('PIN must be 4–8 digits', true); return; }
  if(!pin){ localStorage.removeItem(LS.pin); toast('PIN removed'); return; }
  const hash = await hashPIN(pin); save(LS.pin, hash); document.getElementById('pin').value=''; toast('PIN set');
});
document.getElementById('wipeData').addEventListener('click', ()=>{
  if(confirm('Erase ALL local data (transactions, categories, settings)?')){ localStorage.clear(); location.reload(); }
});

/* =========================
   Month filter & Home KPI
   ========================= */
const filterMonth = document.getElementById('filterMonth');
filterMonth.value = monthKey(new Date());
filterMonth.addEventListener('change', ()=>refreshAll());

function refreshHomeKpiToday(){
  const todayTotal = load(LS.tx, []).filter(t=>t.date===todayStr()).reduce((a,b)=>a+b.amount,0);
  document.getElementById('kpiToday').textContent = fmt(todayTotal);
}

/* =========================
   Utilities
   ========================= */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }
function download(filename, type, content){
  const a=document.createElement('a'); a.download=filename;
  a.href=URL.createObjectURL(new Blob([content],{type}));
  document.body.appendChild(a); a.click(); a.remove();
}
function toast(msg, isError=false){
  const el = document.getElementById('toast');
  el.textContent = msg; el.style.borderColor = isError? '#a32020':'#1c2740';
  el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 1400);
}

/* =========================
   Initial render
   ========================= */
function refreshAll(){
  // quick log category list
  refreshCategoriesSelect();
  // budgets + totals
  renderBudgets();
  // reports
  renderReports();
  // home KPI
  refreshHomeKpiToday();
}
refreshAll();

/* =========================
   Service worker registration
   ========================= */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
}
</script>
</body>
</html>
