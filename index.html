<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>PennyPilot ‚Äî Pro Fintech UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0B1020" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%2310162A'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' dominant-baseline='middle' font-family='Inter,Arial' font-weight='700' font-size='120' fill='%2334d399'%3E%24%3C/text%3E%3C/svg%3E" />
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%2310162A'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' dominant-baseline='middle' font-family='Inter,Arial' font-weight='700' font-size='120' fill='%2334d399'%3E%24%3C/text%3E%3C/svg%3E" />
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0B1020; --card:#0F1B36; --ink:#E6EAF3; --sub:#9AA6C7; --muted:#1D2A4C;
    --accent:#34D399; --accent2:#60A5FA; --warn:#F59E0B; --danger:#EF4444;
    --shadow:0 12px 36px rgba(0,0,0,.35); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:
    radial-gradient(1200px 800px at 85% -10%, #13234b, #0b1020 55%) fixed,
    radial-gradient(900px 600px at -10% 110%, #0c1b3e, transparent 70%) fixed;
    color:var(--ink);font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding-bottom:92px}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b1327,#0b132700);backdrop-filter:blur(8px);padding:16px;text-align:center}
  header h1{margin:0;font-size:20px;font-weight:900;color:var(--accent)}
  main{max-width:1120px;margin:0 auto;padding:16px;display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:960px){main{grid-template-columns:1.15fr .85fr}}
  section{background:linear-gradient(180deg,#0f1b36ee,#0c1730ee);border:1px solid #17264a;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  h2{margin:0 0 12px;font-size:18px}
  label{display:block;font-size:13px;color:var(--sub);margin-bottom:6px}
  input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #1b2c54;background:#0b1730;color:var(--ink)}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .money{font-size:28px;font-weight:900}
  .ring{--pct:0;width:92px;height:92px;border-radius:50%;background:conic-gradient(#34d399 calc(var(--pct)*1%), #1f2a48 0);
    display:grid;place-items:center;box-shadow:inset 0 0 0 10px #0a1426,0 8px 24px rgba(0,0,0,.25)}
  .ring>span{font-weight:900}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid #18264a;font-size:14px;text-align:left;vertical-align:middle}
  th{color:#99aadd}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #2a3b5d;font-size:12px}
  .ok{color:#34d399;border-color:#1e8d6c}.warnP{color:#f59e0b;border-color:#9a6a0d}.over{color:#ef4444;border-color:#a32020}
  .subrow td{background:linear-gradient(180deg,#0a1429,#0a1326)}
  .indent{padding-left:28px}
  .edit-btn{padding:6px 10px;border-radius:8px;border:1px solid #2a3b5d;background:#132447;color:#dbe5ff}
  .badge{padding:2px 6px;border-radius:6px;background:#132447;border:1px solid #253a68;color:#cfe1ff;font-size:11px}
  nav{position:fixed;left:0;right:0;bottom:0;background:rgba(11,19,39,.75);backdrop-filter:blur(10px);border-top:1px solid #17264a;display:grid;grid-template-columns:repeat(4,1fr)}
  nav button{background:none;border:0;color:#b7c4e0;padding:10px 6px;font-size:12px}
  nav button[aria-current="page"]{color:#34d399;font-weight:900;text-shadow:0 0 12px rgba(52,211,153,.45)}
</style>
</head>
<body>
<header><h1>PennyPilot</h1></header>
<main>  <!-- Home -->
  <section id="home">
    <h2>Today</h2>
    <div class="row">
      <div style="flex:1 1 200px">
        <label class="sub">Spent today</label><div class="money" id="kpiToday">$0.00</div>
      </div>
      <div style="flex:1 1 200px">
        <label class="sub">This month</label><div class="money" id="kpiMonth">$0.00</div>
      </div>
      <div style="flex:1 1 200px">
        <label class="sub">Under / Over</label><div class="money" id="kpiDelta">$0.00</div>
      </div>
    </div>
    <div class="row" style="align-items:center;margin-top:12px">
      <div class="ring"><span id="ringPct">0%</span></div>
      <div><div class="badge">Offline ‚Ä¢ Local only</div></div>
    </div>
    <canvas id="trend" height="180" style="margin-top:10px"></canvas>
  </section>

  <!-- Log -->
  <section id="log" style="display:none">
    <h2>Log Expense</h2>
    <div class="row">
      <div style="flex:1 1 140px"><label>Amount</label><input id="amount" inputmode="decimal" placeholder="12.50"></div>
      <div style="flex:1 1 220px"><label>Category / Subcategory</label><select id="category"></select></div>
      <div style="flex:1 1 160px"><label>Date</label><input id="date" type="date"></div>
    </div>
    <div class="row"><div style="flex:1 1 100%"><label>Note</label><input id="note" placeholder="optional note"></div></div>
    <div class="row"><button class="edit-btn" id="saveTx">Save Expense</button><button class="edit-btn" id="wipeTx">Clear</button></div>
  </section>

  <!-- Budgets -->
  <section id="budgets" style="display:none">
    <div class="row" style="align-items:center"><h2 style="margin-right:auto">Budgets</h2><span class="badge">Tap ‚úé to edit</span></div>
    <table id="budgetTable">
      <thead><tr><th>Category</th><th>Budget</th><th>Spent</th><th>%</th><th>Status</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <h3 style="margin:12px 0 6px">Add / Update Category</h3>
    <div class="row">
      <input id="newCat" placeholder="Category (emoji welcome)" style="flex:2 1 220px">
      <input id="newBudget" inputmode="decimal" placeholder="Budget" style="flex:1 1 140px">
      <button class="edit-btn" id="addOrUpdate">Save Budget</button>
    </div>

    <h3 style="margin:12px 0 6px">Add / Update Subcategory</h3>
    <div class="row">
      <input id="parentName" placeholder="Parent category" style="flex:2 1 220px">
      <input id="subName" placeholder="Subcategory" style="flex:2 1 220px">
      <input id="subBudget" inputmode="decimal" placeholder="Budget" style="flex:1 1 140px">
      <button class="edit-btn" id="addSub">Save Subcategory</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="edit-btn" id="resetToStarter">Reset Starter Set</button>
      <button class="edit-btn" id="wipeAll">Erase ALL Local Data</button>
    </div>
  </section>

  <!-- Reports -->
  <section id="reports" style="display:none">
    <h2>Reports</h2>
    <div class="row" style="align-items:end">
      <div><label>Month</label><input type="month" id="filterMonth"></div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="edit-btn" id="exportJson">Export JSON</button>
        <button class="edit-btn" id="importJsonBtn">Import JSON</button>
        <input id="importJson" type="file" accept="application/json" style="display:none">
      </div>
    </div>
    <canvas id="donut" height="220" style="margin-top:10px"></canvas>
    <h3 style="margin:12px 0 6px">Transactions (month)</h3>
    <table id="txTable">
      <thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Note</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<nav>
  <button data-view="home" aria-current="page">Home</button>
  <button data-view="log">Log</button>
  <button data-view="budgets">Budgets</button>
  <button data-view="reports">Reports</button>
</nav><script>
/* ===== Data (with subcategories) ===== */
const LS_CATS='pp_cats_v4'; // [{name,budget,children:[{name,budget}]}]
const LS_TX='pp_txs_v4';    // [{id,date,cat,sub,amt,note}]

const starter = [
  {name:"Groceries üçé", budget:300, children:[{name:"Produce",budget:120},{name:"Snacks",budget:60},{name:"Household",budget:120}]},
  {name:"Dining üçΩ",    budget:150, children:[{name:"Coffee",budget:30},{name:"Takeout",budget:120}]},
  {name:"Transport üöó", budget:120, children:[{name:"Fuel",budget:80},{name:"Transit",budget:40}]},
  {name:"Housing üè†",   budget:800, children:[{name:"Rent/Mortgage",budget:800}]},
  {name:"Utilities üí°", budget:100, children:[{name:"Power",budget:60},{name:"Water",budget:20},{name:"Gas",budget:20}]},
  {name:"Bills üßæ",     budget:0,   children:[{name:"Insurance",budget:120},{name:"Phone",budget:60},{name:"Subscriptions",budget:40}]},
  {name:"Health üè•",    budget:60, children:[]},
  {name:"Entertainment üéÆ", budget:80, children:[{name:"Streaming",budget:30}]},
  {name:"Misc üí∏",      budget:90, children:[]}
];

let cats = JSON.parse(localStorage.getItem(LS_CATS) || 'null');
if(!cats){ cats = starter; localStorage.setItem(LS_CATS, JSON.stringify(cats)); }
let txs  = JSON.parse(localStorage.getItem(LS_TX) || '[]');

/* ===== Utils ===== */
const $  = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const money = n => "$" + Number(n||0).toFixed(2);
const today = () => new Date().toISOString().slice(0,10);
const mkey  = d => (d||today()).slice(0,7);
function saveCats(){ localStorage.setItem(LS_CATS, JSON.stringify(cats)); }
function saveTxs(){ localStorage.setItem(LS_TX, JSON.stringify(txs)); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ===== Category select (Parent and Parent/Sub) ===== */
function refreshCategorySelect(){
  const opts=[];
  cats.forEach(c=>{
    if(c.children?.length){ c.children.forEach(s=>opts.push(`${c.name} / ${s.name}`)); }
    opts.push(c.name);
  });
  $('#category').innerHTML = opts.map(o=>`<option>${o}</option>`).join('');
}
$('#date').value = today();
refreshCategorySelect();

/* ===== Navigation ===== */
$$('nav button').forEach(b=>{
  b.onclick = ()=>{
    const v=b.dataset.view;
    $$('nav button').forEach(x=>x.setAttribute('aria-current', x===b?'page':'false'));
    $$('main > section').forEach(s=> s.style.display = (s.id===v) ? 'block' : 'none');
    if(['home','budgets','reports'].includes(v)) renderAll();
    scrollTo({top:0,behavior:'smooth'});
  };
});
$$('main > section').forEach((s,i)=> s.style.display = i? 'none':'block');

/* ===== Inline editor ===== */
function makeEditable(td, onSave){
  const val = td.dataset.value ?? td.textContent.replace(/[^0-9.]/g,'');
  td.innerHTML = `
    <input class="inline-edit" style="width:120px;padding:6px 8px;border-radius:8px;border:1px solid #2a3b5d;background:#0b1730;color:#e5e7eb" inputmode="decimal" value="${val}">
    <button class="edit-btn" data-ok>Save</button>
    <button class="edit-btn" data-cancel>Cancel</button>
  `;
  td.querySelector('[data-ok]').onclick = ()=>{
    const n = parseFloat(td.querySelector('.inline-edit').value.replace(',','.'));
    if(isNaN(n)||n<0){ alert('Enter a non-negative number'); return; }
    onSave(+n.toFixed(2));
  };
  td.querySelector('[data-cancel]').onclick = ()=> renderBudgets(); // revert
}

/* ===== Math helpers ===== */
function monthSpendMap(monthKey){
  const map = {};
  txs.filter(t=>mkey(t.date)===monthKey).forEach(t=>{
    const key = t.sub ? `${t.cat}::${t.sub}` : t.cat;
    map[key] = (map[key]||0) + t.amt;
  });
  return map;
}
function computeRollups(monthKey){
  const spend = monthSpendMap(monthKey);
  return cats.map(cat=>{
    const own = spend[cat.name]||0;
    const childs = (cat.children||[]).map(sc=>{
      const s = spend[`${cat.name}::${sc.name}`]||0;
      return {name:sc.name, budget:sc.budget||0, spent:s};
    });
    const sumBud = childs.reduce((a,s)=>a+s.budget,0);
    const sumSp  = childs.reduce((a,s)=>a+s.spent,0);
    return {
      cat, catSpentOwn:own, childStats:childs,
      totalBudget:(cat.budget||0)+sumBud,
      totalSpent:own+sumSp
    };
  });
}/* ===== Budgets render + handlers ===== */
let donutChart, trendChart;

function renderBudgets(){
  const tbody = $('#budgetTable tbody');
  const mk = $('#filterMonth').value || mkey(today());
  const rows = computeRollups(mk);

  tbody.innerHTML = rows.map(r=>{
    const pct = r.totalBudget>0 ? (r.totalSpent/r.totalBudget) : 0;
    const pctTxt = r.totalBudget>0 ? Math.round(pct*100)+'%' : '‚Äî';
    const status = r.totalBudget===0 ? 'No budget' : (pct<0.75?'OK':(pct<=1?'Warning':'Over'));
    const pill = status==='OK'?'ok':(status==='Warning'?'warnP':'over');

    const children = r.childStats.map(sc=>{
      const cPct = sc.budget>0 ? sc.spent/sc.budget : 0;
      const cPctTxt = sc.budget>0 ? Math.round(cPct*100)+'%' : '‚Äî';
      const cStatus = sc.budget===0 ? 'No budget' : (cPct<0.75?'OK':(cPct<=1?'Warning':'Over'));
      const cPill = cStatus==='OK
                const cPill = cStatus==='OK' ? 'ok' : (cStatus==='Warning' ? 'warnP' : 'over');
        return `<tr class="subrow">
          <td class="indent"><span class="sub">‚Ü≥</span> ${sc.name}</td>
          <td data-type="subBudget" data-cat="${r.cat.name}" data-sub="${sc.name}" data-value="${sc.budget}">
            ${money(sc.budget)} <button class="edit-btn" data-edit>‚úé</button>
          </td>
          <td>${money(sc.spent)}</td>
          <td>${cPctTxt}</td>
          <td><span class="pill ${cPill}">${cStatus}</span></td>
          <td><button class="edit-btn" data-del-sub="${r.cat.name}::${sc.name}">Delete</button></td>
        </tr>`;
      }).join('');

    return `
      <tr>
        <td><strong>${r.cat.name}</strong></td>
        <td data-type="catBudget" data-cat="${r.cat.name}" data-value="${r.cat.budget||0}">
          ${money(r.cat.budget||0)} <button class="edit-btn" data-edit>‚úé</button>
        </td>
        <td>${money(r.totalSpent)}</td>
        <td>${pctTxt}</td>
        <td><span class="pill ${pill}">${status}</span></td>
        <td><button class="edit-btn" data-del="${r.cat.name}">Delete</button></td>
      </tr>
      ${children}
    `;
  }).join('');

  // Inline editors
  $$('[data-edit]').forEach(btn=>{
    btn.onclick = (e)=>{
      const td = e.target.closest('td');
      makeEditable(td, (num)=>{
        if(td.dataset.type==='catBudget'){
          const c = cats.find(x=>x.name===td.dataset.cat); if(!c) return;
          c.budget = num;
        }else{
          const c = cats.find(x=>x.name===td.dataset.cat); if(!c) return;
          const s = c.children.find(y=>y.name===td.dataset.sub); if(!s) return;
          s.budget = num;
        }
        saveCats(); renderBudgets();
      });
    };
  });

  // Deletes
  $$('[data-del]').forEach(b=> b.onclick = ()=>{
    const name = b.getAttribute('data-del');
    if(!confirm(`Delete category "${name}"? Transactions remain.`)) return;
    cats = cats.filter(c=>c.name!==name); saveCats(); refreshCategorySelect(); renderAll();
  });
  $$('[data-del-sub]').forEach(b=> b.onclick = ()=>{
    const [pc,sc] = b.getAttribute('data-del-sub').split('::');
    const c = cats.find(x=>x.name===pc); if(!c) return;
    c.children = c.children.filter(s=>s.name!==sc);
    saveCats(); refreshCategorySelect(); renderAll();
  });

  // KPIs + ring
  const totals = rows.reduce((a,r)=>({budget:a.budget+r.totalBudget, spent:a.spent+r.totalSpent}),{budget:0,spent:0});
  $('#kpiMonth').textContent = money(totals.spent);
  const delta = totals.budget - totals.spent;
  $('#kpiDelta').textContent = (delta>=0?'+':'-') + money(Math.abs(delta));
  const pct = totals.budget>0 ? Math.min(1, totals.spent/totals.budget) : 0;
  document.querySelector('.ring').style.setProperty('--pct', (pct*100).toFixed(1));
  $('#ringPct').textContent = `${Math.round(pct*100)}%`;
}

/* ===== Transactions table ===== */
function renderTxTable(){
  const tbody = document.querySelector('#txTable tbody');
  const mk = document.querySelector('#filterMonth')?.value || mkey(today());
  const list = txs.filter(t=>mkey(t.date)===mk).sort((a,b)=>a.date<b.date?1:-1);
  tbody.innerHTML = list.map(t=>`
    <tr>
      <td>${t.date}</td>
      <td>${t.cat}${t.sub? ' / '+t.sub:''}</td>
      <td>${money(t.amt)}</td>
      <td>${escapeHtml(t.note||'')}</td>
      <td><button class="edit-btn" data-rm="${t.id}">Delete</button></td>
    </tr>
  `).join('');
  $$('[data-rm]').forEach(b=> b.onclick = ()=>{
    const id=b.getAttribute('data-rm');
    txs = txs.filter(x=>x.id!==id);
    saveTxs(); renderAll();
  });
}

/* ===== Charts ===== */
function renderCharts(){
  const mk = document.querySelector('#filterMonth')?.value || mkey(today());
  const rows = computeRollups(mk);

  // Donut uses subs if present, else parent
  const labels = rows.flatMap(r=>{
    const subs = (r.childStats||[]).map(s=>`${r.cat.name} / ${s.name}`);
    return subs.length ? subs : [r.cat.name];
  });
  const values = rows.flatMap(r=>{
    const subs = (r.childStats||[]).map(s=>s.spent);
    return subs.length ? subs : [r.totalSpent];
  });

  donutChart && donutChart.destroy();
  donutChart = new Chart(document.getElementById('donut'), {
    type:'doughnut',
    data:{ labels, datasets:[{ data: values,
      backgroundColor:['#34d399','#60a5fa','#f59e0b','#f472b6','#a78bfa','#f87171','#22d3ee','#fb7185','#4ade80','#facc15'] }] },
    options:{ plugins:{ legend:{ position:'bottom', labels:{ color:'#e5e7eb' } } } }
  });

  const months = [...new Set(txs.map(t=>mkey(t.date)))].sort();
  const totals = months.map(m=> txs.filter(t=>mkey(t.date)===m).reduce((a,b)=>a+b.amt,0));
  trendChart && trendChart.destroy();
  trendChart = new Chart(document.getElementById('trend'), {
    type:'line',
    data:{ labels: months, datasets:[{ data: totals, borderColor:'#34d399', backgroundColor:'#10b98133', tension:.25, fill:true }]},
    options:{ plugins:{ legend:{display:false}}, scales:{ x:{ ticks:{ color:'#9ca3af'}}, y:{ ticks:{ color:'#9ca3af'}}}}
  });
}

/* ===== KPI: today ===== */
function renderKpisToday(){
  const t = txs.filter(x=>x.date===today()).reduce((a,b)=>a+b.amt,0);
  document.getElementById('kpiToday').textContent = money(t);
}

/* ===== Log actions ===== */
document.getElementById('saveTx').onclick = ()=>{
  const amt = parseFloat(document.getElementById('amount').value.replace(',','.'));
  const sel = document.getElementById('category').value; // "Parent / Sub" or "Parent"
  const [parent, child] = sel.split(' / ').map(s=>s.trim());
  const date = document.getElementById('date').value || today();
  const note = document.getElementById('note').value.trim();
  if(!(amt>0)) return alert('Enter a positive amount');

  txs.push({id:crypto.randomUUID(), amt:+amt.toFixed(2), cat:parent, sub:(child||''), date, note});
  saveTxs();
  document.getElementById('amount').value=''; document.getElementById('note').value='';
  renderAll(); alert('Saved ‚úÖ');
};
document.getElementById('wipeTx').onclick = ()=>{
  document.getElementById('amount').value=''; document.getElementById('note').value='';
};

/* ===== Add / Update Category & Sub ===== */
document.getElementById('addOrUpdate').onclick = ()=>{
  const name = document.getElementById('newCat').value.trim();
  const b = parseFloat(document.getElementById('newBudget').value.replace(',','.'));
  if(!name || isNaN(b) || b<0) return alert('Enter a category and a non-negative budget');
  const i = cats.findIndex(c=>c.name.toLowerCase()===name.toLowerCase());
  if(i>=0) cats[i].budget = +b.toFixed(2);
  else cats.push({name, budget:+b.toFixed(2), children:[]});
  saveCats(); document.getElementById('newCat').value=''; document.getElementById('newBudget').value='';
  refreshCategorySelect(); renderAll();
};
document.getElementById('addSub').onclick = ()=>{
  const parent = document.getElementById('parentName').value.trim();
  const name = document.getElementById('subName').value.trim();
  const b = parseFloat(document.getElementById('subBudget').value.replace(',','.'));
  if(!parent || !name || isNaN(b) || b<0) return alert('Parent, subcategory, budget required');
  const c = cats.find(x=>x.name.toLowerCase()===parent.toLowerCase());
  if(!c) return alert('Parent category not found');
  const j = c.children.findIndex(s=>s.name.toLowerCase()===name.toLowerCase());
  if(j>=0) c.children[j].budget = +b.toFixed(2); else c.children.push({name, budget:+b.toFixed(2)});
  saveCats(); document.getElementById('parentName').value=''; document.getElementById('subName').value=''; document.getElementById('subBudget').value='';
  refreshCategorySelect(); renderAll();
};

/* ===== Resets & Import/Export ===== */
document.getElementById('resetToStarter').onclick = ()=>{
  if(!confirm('Reset categories to starter set? Transactions remain.')) return;
  cats = JSON.parse(JSON.stringify(starter)); saveCats(); refreshCategorySelect(); renderAll();
};
document.getElementById('wipeAll').onclick = ()=>{
  if(!confirm('Erase ALL local data?')) return;
  localStorage.removeItem(LS_CATS); localStorage.removeItem(LS_TX);
  cats = JSON.parse(JSON.stringify(starter)); txs = []; saveCats(); saveTxs(); refreshCategorySelect(); renderAll();
};
document.getElementById('exportJson').onclick = ()=>{
  const blob = new Blob([JSON.stringify({cats,txs},null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`pennypilot-backup-${Date.now()}.json`; a.click(); a.remove();
};
document.getElementById('importJsonBtn').onclick = ()=> document.getElementById('importJson').click();
document.getElementById('importJson').onchange = async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const obj = JSON.parse(await f.text());
    if(!Array.isArray(obj.cats) || !Array.isArray(obj.txs)) throw 0;
    cats=obj.cats; txs=obj.txs; saveCats(); saveTxs(); refreshCategorySelect(); renderAll(); alert('Imported ‚úÖ');
  }catch{ alert('Invalid backup file'); }
};

/* ===== Month filter + initial render ===== */
document.getElementById('filterMonth').value = mkey(today());
document.getElementById('filterMonth').onchange = ()=> renderAll();

function renderAll(){ renderBudgets(); renderTxTable(); renderCharts(); renderKpisToday(); }
refreshCategorySelect(); renderAll();

/* ===== Service Worker (offline) ===== */
if('serviceWorker' in navigator){ addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }
</script><script>
/* ---------- PennyPilot Safe Boot Patch ---------- */
// 1) Surface any hidden JS error so we know immediately if something else breaks
window.onerror = function (msg, src, line, col) {
  const box = document.createElement('div');
  box.style.cssText = 'position:fixed;left:8px;right:8px;bottom:84px;z-index:9999;background:#1b273f;color:#ffb4b4;border:1px solid #7a1a1a;padding:10px;border-radius:10px;font:13px/1.4 system-ui';
  box.textContent = 'JS Error: ' + msg + ' @ ' + (src||'inline') + ':' + line + ':' + col;
  document.body.appendChild(box);
  setTimeout(()=>box.remove(), 8000);
};

// 2) Make renderAll tolerant if Chart.js isn't ready yet
(function patchRenderAll(){
  if (typeof renderAll === 'function') {
    const _renderAll = renderAll;
    window.renderAll = function(){
      try{
        // run everything except charts
        if (typeof renderBudgets === 'function') renderBudgets();
        if (typeof renderTxTable === 'function') renderTxTable();
        if (typeof renderKpisToday === 'function') renderKpisToday();

        // render charts only when Chart is present
        if (window.Chart && typeof renderCharts === 'function') {
          renderCharts();
        } else {
          window.addEventListener('load', () => {
            if (window.Chart && typeof renderCharts === 'function') renderCharts();
          }, {once:true});
        }
      }catch(e){ console.error(e); }
    };
  }
})();

// 3) Re-wire critical buttons & nav in case earlier code bailed out
(function ensureHandlers(){
  // Nav
  const navBtns = document.querySelectorAll('nav button[data-view]');
  const sections = document.querySelectorAll('main > section');
  if (navBtns.length && sections.length) {
    navBtns.forEach(b=>{
      if (b._wired) return; b._wired = true;
      b.addEventListener('click', ()=>{
        const v=b.dataset.view;
        navBtns.forEach(x=>x.setAttribute('aria-current', x===b?'page':'false'));
        sections.forEach(s=> s.style.display = (s.id===v)?'block':'none');
        if (typeof renderAll === 'function' && (v==='home'||v==='budgets'||v==='reports')) renderAll();
        scrollTo({top:0,behavior:'smooth'});
      }, {passive:true});
    });
  }

  // Save / Clear
  const save = document.getElementById('saveTx');
  const wipe = document.getElementById('wipeTx');
  if (save && !save._wired) {
    save._wired = true;
    save.addEventListener('click', ()=>{
      if (typeof window.saveTx === 'function') return window.saveTx();
      // minimal fallback (shouldn't be needed)
      const amt = parseFloat((document.getElementById('amount').value||'').replace(',','.'));
      if (!(amt>0)) return alert('Enter a positive amount');
      const sel = document.getElementById('category').value||'';
      const [cat, sub] = sel.split(' / ').map(s=>s?.trim());
      const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
      const note = document.getElementById('note').value||'';
      const txs = JSON.parse(localStorage.getItem('pp_txs_v4')||'[]');
      txs.push({id:crypto.randomUUID?.()||String(Date.now()), amt:+amt.toFixed(2), cat:cat||'Uncategorized', sub:sub||'', date, note});
      localStorage.setItem('pp_txs_v4', JSON.stringify(txs));
      alert('Saved ‚úÖ'); location.reload();
    });
  }
  if (wipe && !wipe._wired) {
    wipe._wired = true;
    wipe.addEventListener('click', ()=>{
      const a=document.getElementById('amount'); if(a) a.value='';
      const n=document.getElementById('note'); if(n) n.value='';
    });
  }
})();

// 4) Kick a fresh render once everything (including Chart.js) is ready
window.addEventListener('load', ()=>{
  if (typeof renderAll === 'function') renderAll();
});
</script><script>
/* ====== PennyPilot click-fix patch (safe to append) ====== */
(function(){
  // simple toast
  function toast(msg, ok=true){
    const d=document.createElement('div');
    d.style.cssText='position:fixed;left:12px;right:12px;bottom:84px;z-index:9999;padding:12px 14px;border-radius:12px;font:14px system-ui';
    d.style.background = ok ? '#0d2a1e' : '#2a1414';
    d.style.border = '1px solid ' + (ok ? '#1f8b66' : '#8b1f1f');
    d.style.color = ok ? '#a7f3d0' : '#feb2b2';
    d.textContent = msg;
    document.body.appendChild(d); setTimeout(()=>d.remove(), 2500);
  }
  const $ = id => document.getElementById(id);

  // Ensure type=button and wire handler (prevents silent form submits)
  function wire(id, fn){
    const el = $(id); if(!el) return;
    el.setAttribute('type','button');
    el.onclick = (e)=>{ e.preventDefault(); try{ fn(); } catch(err){ console.error(err); toast(err.message,false); } };
  }

  // Guard: if global data not present, create minimal defaults
  window.cats ||= [];
  window.txs  ||= [];
  window.saveCats ||= function(){ localStorage.setItem('pp_cats_v4', JSON.stringify(cats)); };
  window.saveTxs  ||= function(){ localStorage.setItem('pp_txs_v4',  JSON.stringify(txs));  };

  // Rebuild category dropdown safely
  function refreshSelect(){
    if (!$('#category')) return;
    const opts=[];
    (cats||[]).forEach(c=>{
      (c.children||[]).forEach(s=>opts.push(`${c.name} / ${s.name}`));
      opts.push(c.name);
    });
    $('#category').innerHTML = opts.map(o=>`<option>${o}</option>`).join('');
  }

  // ==== Save Expense
  wire('saveTx', function(){
    const amt = parseFloat(($('#amount')?.value||'').replace(',','.'));
    if(!(amt>0)) return toast('Enter a positive amount', false);
    const sel = $('#category')?.value || '';
    const [parent, child] = sel.split(' / ').map(s=>s?.trim());
    const date = $('#date')?.value || new Date().toISOString().slice(0,10);
    const note = $('#note')?.value?.trim() || '';
    txs.push({id: (crypto.randomUUID?.()||String(Date.now())), amt:+amt.toFixed(2), cat:parent||'Uncategorized', sub:child||'', date, note});
    saveTxs(); toast('Expense saved ‚úÖ');
    if ($('#amount')) $('#amount').value=''; if ($('#note')) $('#note').value='';
    if (typeof renderAll==='function') renderAll();
  });

  // ==== Clear form
  wire('wipeTx', function(){
    if ($('#amount')) $('#amount').value='';
    if ($('#note'))   $('#note').value='';
    toast('Cleared');
  });

  // ==== Add / Update Category
  wire('addOrUpdate', function(){
    const name = ($('#newCat')?.value||'').trim();
    const b    = parseFloat(($('#newBudget')?.value||'').replace(',','.'));
    if(!name || isNaN(b) || b<0) return toast('Enter category & non-negative budget', false);
    const i = (cats||[]).findIndex(c=>c.name.toLowerCase()===name.toLowerCase());
    if(i>=0) cats[i].budget = +b.toFixed(2);
    else cats.push({name, budget:+b.toFixed(2), children:[]});
    saveCats(); refreshSelect(); toast('Category saved ‚úîÔ∏è');
    if ($('#newCat')) $('#newCat').value=''; if ($('#newBudget')) $('#newBudget').value='';
    if (typeof renderAll==='function') renderAll();
  });

  // ==== Add / Update Subcategory
  wire('addSub', function(){
    const parent = ($('#parentName')?.value||'').trim();
    const name   = ($('#subName')?.value||'').trim();
    const b      = parseFloat(($('#subBudget')?.value||'').replace(',','.'));
    if(!parent || !name || isNaN(b) || b<0) return toast('Parent, subcategory, budget required', false);
    const c = (cats||[]).find(x=>x.name.toLowerCase()===parent.toLowerCase());
    if(!c) return toast('Parent category not found', false);
    const j = (c.children||[]).findIndex(s=>s.name.toLowerCase()===name.toLowerCase());
    if(j>=0) c.children[j].budget = +b.toFixed(2); else (c.children||(c.children=[])).push({name, budget:+b.toFixed(2)});
    saveCats(); refreshSelect(); toast('Subcategory saved ‚úîÔ∏è');
    if ($('#parentName')) $('#parentName').value='';
    if ($('#subName'))    $('#subName').value='';
    if ($('#subBudget'))  $('#subBudget').value='';
    if (typeof renderAll==='function') renderAll();
  });

  // Rebind month filter (in case earlier script failed before wiring)
  if ($('#filterMonth')) {
    $('#filterMonth').value = (new Date()).toISOString().slice(0,7);
    $('#filterMonth').onchange = ()=> typeof renderAll==='function' && renderAll();
  }

  // If the main script crashed before, give it a nudge now
  refreshSelect();
  if (typeof renderAll==='function') renderAll();
})();
</script><script>
/* ====== Robust Save handlers patch (append-only) ====== */
(function(){
  const $ = (id) => document.getElementById(id);
  const debug = (msg) => {
    const d=document.createElement('div');
    d.style.cssText='position:fixed;left:12px;right:12px;bottom:84px;z-index:9999;padding:10px 12px;border-radius:10px;background:#1b273f;color:#cde1ff;border:1px solid #2c3f6a;font:13px system-ui';
    d.textContent = msg; document.body.appendChild(d); setTimeout(()=>d.remove(), 3000);
  };
  const toast = (msg, ok=true) => {
    const d=document.createElement('div');
    d.style.cssText='position:fixed;left:12px;right:12px;bottom:48px;z-index:9999;padding:12px 14px;border-radius:12px;font:14px system-ui';
    d.style.background = ok ? '#0d2a1e' : '#2a1414';
    d.style.border = '1px solid ' + (ok ? '#1f8b66' : '#8b1f1f');
    d.style.color = ok ? '#a7f3d0' : '#feb2b2';
    d.textContent = msg; document.body.appendChild(d); setTimeout(()=>d.remove(), 2600);
  };
  const normNum = (v) => {
    // strip everything except digits, dot, minus
    const clean = String(v ?? '').replace(/[^\d.\-]/g,'');
    return clean === '' ? NaN : Number(clean);
  };

  // Rebind Add / Update Category with stronger parsing
  const catBtn = $('addOrUpdate');
  if (catBtn) {
    catBtn.type = 'button';
    catBtn.onclick = () => {
      try{
        const name = ($('newCat')?.value || '').trim();
        const bRaw = $('newBudget')?.value ?? '';
        const b = normNum(bRaw);
        if (!name || isNaN(b) || b < 0) {
          debug(`name="${name}"  budgetRaw="${bRaw}"  parsed=${b}`);
          return toast('Enter category & non-negative budget', false);
        }
        // ensure globals exist
        if (typeof cats === 'undefined') window.cats = [];
        if (!Array.isArray(cats)) window.cats = [];
        if (typeof saveCats !== 'function') window.saveCats = ()=>localStorage.setItem('pp_cats_v4', JSON.stringify(cats));

        const i = cats.findIndex(c=>c.name.toLowerCase()===name.toLowerCase());
        if (i >= 0) cats[i].budget = +b.toFixed(2);
        else cats.push({name, budget:+b.toFixed(2), children:[]});
        saveCats();
        if (typeof refreshCategorySelect === 'function') refreshCategorySelect();
        if ($('newCat')) $('newCat').value = '';
        if ($('newBudget')) $('newBudget').value = '';
        if (typeof renderAll === 'function') renderAll();
        toast('Category saved ‚úîÔ∏è');
      }catch(e){ console.error(e); toast(e.message, false); }
    };
  }

  // Rebind Add / Update Subcategory
  const subBtn = $('addSub');
  if (subBtn) {
    subBtn.type = 'button';
    subBtn.onclick = () => {
      try{
        const parent = ($('parentName')?.value || '').trim();
        const name   = ($('subName')?.value || '').trim();
        const bRaw   = $('subBudget')?.value ?? '';
        const b = normNum(bRaw);
        if (!parent || !name || isNaN(b) || b < 0) {
          debug(`parent="${parent}"  sub="${name}"  budgetRaw="${bRaw}" parsed=${b}`);
          return toast('Parent, subcategory & non-negative budget required', false);
        }
        if (!Array.isArray(cats)) window.cats = [];
        const c = cats.find(x=>x.name.toLowerCase()===parent.toLowerCase());
        if (!c) return toast('Parent category not found', false);
        c.children ||= [];
        const j = c.children.findIndex(s=>s.name.toLowerCase()===name.toLowerCase());
        if (j >= 0) c.children[j].budget = +b.toFixed(2);
        else c.children.push({name, budget:+b.toFixed(2)});
        saveCats();
        if (typeof refreshCategorySelect === 'function') refreshCategorySelect();
        if ($('parentName')) $('parentName').value='';
        if ($('subName')) $('subName').value='';
        if ($('subBudget')) $('subBudget').value='';
        if (typeof renderAll === 'function') renderAll();
        toast('Subcategory saved ‚úîÔ∏è');
      }catch(e){ console.error(e); toast(e.message, false); }
    };
  }

  // Make "Tap ‚úé to edit" possible by ensuring rows exist after first save
  // (once a category is saved, render adds edit buttons)
  // Also wire Save Expense if needed
  const saveTxBtn = $('saveTx');
  if (saveTxBtn && !saveTxBtn._wired) {
    saveTxBtn._wired = true;
    saveTxBtn.type = 'button';
    saveTxBtn.onclick = () => {
      const amt = normNum($('amount')?.value);
      if (!(amt > 0)) return toast('Enter a positive amount', false);
      const sel = $('category')?.value || '';
      const [parent, child] = sel.split(' / ').map(s=>s?.trim());
      const date = $('date')?.value || new Date().toISOString().slice(0,10);
      const note = $('note')?.value?.trim() || '';
      try{
        if (!Array.isArray(window.txs)) window.txs = [];
        if (typeof saveTxs !== 'function') window.saveTxs = ()=>localStorage.setItem('pp_txs_v4', JSON.stringify(txs));
        txs.push({id: crypto.randomUUID?.() || String(Date.now()), amt:+amt.toFixed(2), cat:parent||'Uncategorized', sub:child||'', date, note});
        saveTxs();
        if ($('amount')) $('amount').value='';
        if ($('note')) $('note').value='';
        if (typeof renderAll === 'function') renderAll();
        toast('Expense saved ‚úÖ');
      }catch(e){ console.error(e); toast(e.message, false); }
    };
  }
})();
</script>
</body>
</html>
