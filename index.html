<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PennyPilot ‚Äî Budget & Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1f2937" />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    /* Minimal, mobile-first UI */
    :root{
      --bg:#0b1220;--card:#111827;--ink:#e5e7eb;--muted:#1f2937;
      --green:#34d399;--amber:#f59e0b;--red:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;padding-bottom:84px}
    header{position:sticky;top:0;z-index:2;background:#0e1627;padding:14px;text-align:center;font-weight:800}
    main{max-width:940px;margin:0 auto;padding:14px}
    section{background:var(--card);border:1px solid var(--muted);border-radius:14px;padding:14px;margin:12px 0}
    h2{margin:0 0 10px}
    label{display:block;font-size:13px;color:#9ca3af;margin:6px 0}
    input,select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--muted);background:#0f172a;color:var(--ink)}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .grow{flex:1 1 160px}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn{background:linear-gradient(180deg,#34d399,#10b981);color:#062016}
    .btn.secondary{background:#1b2742;color:#e5e7eb;border:1px solid #28365d}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706);color:#251400}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);color:#2b0000}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--muted);text-align:left;font-size:14px}
    .pill{padding:3px 8px;border-radius:999px;border:1px solid #2a3b5d;font-size:12px}
    .ok{color:#34d399;border-color:#1e8d6c}.warnP{color:#f59e0b;border-color:#9a6a0d}.over{color:#ef4444;border-color:#a32020}
    nav{position:fixed;left:0;right:0;bottom:0;background:#0e1627;border-top:1px solid #1b2540;display:flex;gap:6px;padding:8px}
    nav button{flex:1;background:none;border:0;color:#9ca3af;padding:8px}
    nav button.active{color:#34d399;font-weight:800}
    .note{color:#9ca3af;font-size:13px}
  </style>
</head>
<body>
<header>PennyPilot</header>
<main>
  <!-- Home / KPIs -->
  <section id="home">
    <h2>Today</h2>
    <div class="row">
      <div class="grow">
        <label>Spent today</label>
        <div id="todaySpend" style="font-weight:800;font-size:22px">$0.00</div>
      </div>
      <div class="grow">
        <label>This month</label>
        <div id="monthSpend" style="font-weight:800;font-size:22px">$0.00</div>
      </div>
      <div class="grow">
        <label>Under / Over</label>
        <div id="deltaSpend" style="font-weight:800;font-size:22px">$0.00</div>
      </div>
    </div>
    <canvas id="trend" height="160"></canvas>
  </section>

  <!-- Quick Log -->
  <section id="log">
    <h2>Log Expense</h2>
    <div class="row">
      <div class="grow">
        <label>Amount</label>
        <input id="amount" inputmode="decimal" placeholder="e.g., 12.50">
      </div>
      <div class="grow">
        <label>Category</label>
        <select id="category"></select>
      </div>
      <div class="grow">
        <label>Date</label>
        <input id="date" type="date">
      </div>
    </div>
    <div class="row">
      <div class="grow">
        <label>Note</label>
        <input id="note" placeholder="optional note">
      </div>
    </div>
    <div class="row">
      <button class="btn" id="saveTx">Save Expense</button>
      <button class="btn secondary" id="wipeTx">Clear Form</button>
    </div>
  </section>

  <!-- Budgets (editable) -->
  <section id="budgets">
    <h2>Budgets</h2>
    <table id="budgetTable">
      <thead><tr><th>Category</th><th>Budget</th><th>Spent</th><th>%</th><th>Status</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="row" style="margin-top:10px">
      <input class="grow" id="newCat" placeholder="Category name (emoji welcome)">
      <input class="grow" id="newBudget" inputmode="decimal" placeholder="Monthly budget">
      <button class="btn" id="addOrUpdate">Add / Update</button>
    </div>
    <p class="note">Tip: To change a budget, type the exact category name and a new amount, then press ‚ÄúAdd / Update‚Äù.</p>

    <div class="row" style="margin-top:10px">
      <button class="btn secondary" id="resetToStarter">Reset to Starter Set</button>
      <button class="btn danger" id="wipeAll">Erase ALL Local Data</button>
    </div>
  </section>

  <!-- Reports -->
  <section id="reports">
    <h2>Reports</h2>
    <div class="row">
      <input class="grow" type="month" id="filterMonth">
      <button class="btn secondary" id="exportJson">Export JSON</button>
      <button class="btn secondary" id="importJsonBtn">Import JSON</button>
      <input id="importJson" type="file" accept="application/json" style="display:none">
    </div>
    <canvas id="donut" height="200" style="margin-top:10px"></canvas>
    <h3 style="margin:12px 0 6px">Transactions (month)</h3>
    <table id="txTable">
      <thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Note</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<nav>
  <button data-view="home" class="active">Home</button>
  <button data-view="log">Log</button>
  <button data-view="budgets">Budgets</button>
  <button data-view="reports">Reports</button>
</nav>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ========= Storage ========= */
const LS_CATS='pp_cats_v2'; // categories [{name,budget}]
const LS_TX='pp_txs_v2';    // transactions [{id,date,cat,amt,note}]

const starter = [
  {name:"Groceries üçé", budget:300},
  {name:"Dining üçΩ", budget:150},
  {name:"Transport üöó", budget:120},
  {name:"Housing üè†", budget:800},
  {name:"Utilities üí°", budget:100},
  {name:"Health üè•", budget:60},
  {name:"Entertainment üéÆ", budget:80},
  {name:"Misc üí∏", budget:90},
];

let cats = JSON.parse(localStorage.getItem(LS_CATS) || 'null');
if(!cats){ cats = starter; localStorage.setItem(LS_CATS, JSON.stringify(cats)); }
let txs  = JSON.parse(localStorage.getItem(LS_TX) || '[]');

/* ========= Helpers ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const money = n => "$" + (Number(n||0)).toFixed(2);
const today = () => new Date().toISOString().slice(0,10);
const mkey = d => (d||today()).slice(0,7);

/* ========= UI Init ========= */
function fillCategories(){
  $('#category').innerHTML = cats.map(c=>`<option>${c.name}</option>`).join('');
}
function setDefaultDate(){ $('#date').value = today(); }
fillCategories(); setDefaultDate();

/* ========= Nav ========= */
$$('nav button').forEach(b=>{
  b.addEventListener('click', ()=>{
    const v = b.dataset.view;
    $$('nav button').forEach(x=>x.classList.toggle('active', x===b));
    $$('main > section').forEach(s=> s.style.display = (s.id===v) ? 'block' : 'none');
    if(v==='home'||v==='budgets'||v==='reports') renderAll();
    scrollTo({top:0,behavior:'smooth'});
  });
});
$$('main > section').forEach((s,i)=> s.style.display = i? 'none':'block');

/* ========= CRUD: Transactions ========= */
$('#saveTx').addEventListener('click', ()=>{
  const amt = parseFloat($('#amount').value.replace(',','.'));
  const cat = $('#category').value.trim();
  const date = $('#date').value || today();
  const note = $('#note').value.trim();
  if(!(amt>0)) return alert('Enter a positive amount');
  if(!cat) return alert('Choose a category');

  txs.push({id:crypto.randomUUID(), amt:+amt.toFixed(2), cat, date, note});
  localStorage.setItem(LS_TX, JSON.stringify(txs));
  $('#amount').value = ''; $('#note').value='';
  renderAll(); alert('Saved ‚úÖ');
});
$('#wipeTx').addEventListener('click', ()=>{ $('#amount').value=''; $('#note').value=''; });

/* ========= Budgets: Add/Update/Delete/Reset ========= */
$('#addOrUpdate').addEventListener('click', ()=>{
  const name = $('#newCat').value.trim();
  const b = parseFloat($('#newBudget').value.replace(',','.'));
  if(!name || isNaN(b) || b<0) return alert('Enter a category and a non-negative budget');
  const i = cats.findIndex(c=>c.name.toLowerCase()===name.toLowerCase());
  if(i>=0){ cats[i].budget = +b.toFixed(2); }
  else { cats.push({name, budget:+b.toFixed(2)}); }
  localStorage.setItem(LS_CATS, JSON.stringify(cats));
  $('#newCat').value=''; $('#newBudget').value='';
  fillCategories(); renderAll(); alert('Budget saved ‚úîÔ∏è');
});

$('#resetToStarter').addEventListener('click', ()=>{
  if(!confirm('Reset categories to the starter set? Transactions remain.')) return;
  cats = starter; localStorage.setItem(LS_CATS, JSON.stringify(cats));
  fillCategories(); renderAll();
});

$('#wipeAll').addEventListener('click', ()=>{
  if(!confirm('Erase ALL local data (categories, budgets, and transactions)?')) return;
  localStorage.removeItem(LS_CATS);
  localStorage.removeItem(LS_TX);
  cats = starter; txs = [];
  localStorage.setItem(LS_CATS, JSON.stringify(cats));
  fillCategories(); setDefaultDate(); renderAll();
});

/* ========= Reports & Tables ========= */
let donutChart, trendChart;
function renderBudgets(){
  const tbody = $('#budgetTable tbody');
  const month = $('#filterMonth').value || mkey(today());
  const spent = Object.fromEntries(cats.map(c=>[c.name,0]));
  txs.filter(t=>mkey(t.date)===month).forEach(t=> spent[t.cat]=(spent[t.cat]||0)+t.amt);

  tbody.innerHTML = cats.map(c=>{
    const s = +(spent[c.name]||0).toFixed(2);
    const pct = c.budget>0 ? (s/c.budget) : 0;
    const pctTxt = c.budget>0 ? Math.round(pct*100)+'%' : '‚Äî';
    const status = c.budget===0 ? 'No budget'
      : (pct<0.75 ? 'OK' : (pct<=1 ? 'Warning' : 'Over'));
    const pill = status==='OK'?'ok':(status==='Warning'?'warnP':'over');
    return `<tr>
      <td>${c.name}</td>
      <td>${money(c.budget)}</td>
      <td>${money(s)}</td>
      <td>${pctTxt}</td>
      <td><span class="pill ${pill}">${status}</span></td>
      <td><button class="btn secondary" data-del="${c.name}">Delete</button></td>
    </tr>`;
  }).join('');

  // delete handlers
  $$('button[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const name = btn.getAttribute('data-del');
      if(!confirm(`Delete category "${name}"? Transactions remain.`)) return;
      cats = cats.filter(c=>c.name!==name);
      localStorage.setItem(LS_CATS, JSON.stringify(cats));
      fillCategories(); renderAll();
    };
  });

  // KPIs
  const totals = cats.reduce((a,c)=>({budget:a.budget+c.budget, spent:a.spent+(spent[c.name]||0)}),{budget:0,spent:0});
  $('#monthSpend').textContent = money(totals.spent);
  const delta = totals.budget - totals.spent;
  $('#deltaSpend').textContent = (delta>=0?'+':'-') + money(Math.abs(delta));
}

function renderTxTable(){
  const tbody = $('#txTable tbody');
  const month = $('#filterMonth').value || mkey(today());
  const list = txs.filter(t=>mkey(t.date)===month).sort((a,b)=>a.date<b.date?1:-1);
  tbody.innerHTML = list.map(t=>`
    <tr>
      <td>${t.date}</td><td>${t.cat}</td><td>${money(t.amt)}</td><td>${t.note||''}</td>
      <td><button class="btn secondary" data-rm="${t.id}">Delete</button></td>
    </tr>
  `).join('');
  $$('button[data-rm]').forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute('data-rm');
      txs = txs.filter(x=>x.id!==id);
      localStorage.setItem(LS_TX, JSON.stringify(txs));
      renderAll();
    };
  });
}

function renderCharts(){
  // donut
  const month = $('#filterMonth').value || mkey(today());
  const byCat = cats.map(c=>({name:c.name, sum:0}));
  txs.filter(t=>mkey(t.date)===month).forEach(t=>{
    const i = byCat.findIndex(x=>x.name===t.cat);
    if(i>=0) byCat[i].sum += t.amt;
  });
  donutChart && donutChart.destroy();
  donutChart = new Chart($('#donut'), {
    type:'doughnut',
    data:{ labels:byCat.map(x=>x.name), datasets:[{ 
      data: byCat.map(x=>x.sum),
      backgroundColor:['#34d399','#60a5fa','#f59e0b','#f472b6','#a78bfa','#f87171','#22d3ee','#fb7185']
    }]},
    options:{ plugins:{ legend:{ position:'bottom', labels:{ color:'#e5e7eb' } } } }
  });

  // trend 6-months
  const months = [...new Set(txs.map(t=>mkey(t.date)))].sort();
  const totals = months.map(m=> txs.filter(t=>mkey(t.date)===m).reduce((a,b)=>a+b.amt,0));
  trendChart && trendChart.destroy();
  trendChart = new Chart($('#trend'), {
    type:'line',
    data:{ labels: months, datasets:[{ data: totals, borderColor:'#34d399', backgroundColor:'#10b98133', tension:.25, fill:true }]},
    options:{ plugins:{ legend:{display:false}}, scales:{ x:{ ticks:{ color:'#9ca3af'}}, y:{ ticks:{ color:'#9ca3af'}}}}
  });
}

function renderKpisToday(){
  const t = txs.filter(x=>x.date===today()).reduce((a,b)=>a+b.amt,0);
  $('#todaySpend').textContent = money(t);
}

$('#filterMonth').value = mkey(today());
$('#filterMonth').addEventListener('change', ()=>renderAll());

/* ========= Export/Import ========= */
$('#exportJson').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({cats,txs},null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`pennypilot-backup-${Date.now()}.json`; a.click(); a.remove();
});
$('#importJsonBtn').addEventListener('click', ()=> $('#importJson').click());
$('#importJson').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const obj = JSON.parse(await f.text());
    if(!Array.isArray(obj.cats) || !Array.isArray(obj.txs)) throw 0;
    cats = obj.cats; txs = obj.txs;
    localStorage.setItem(LS_CATS, JSON.stringify(cats));
    localStorage.setItem(LS_TX, JSON.stringify(txs));
    fillCategories(); renderAll(); alert('Imported ‚úÖ');
  }catch{ alert('Invalid backup file'); }
});

/* ========= Render All ========= */
function renderAll(){ renderBudgets(); renderTxTable(); renderCharts(); renderKpisToday(); }
renderAll();

/* ========= Service Worker ========= */
if('serviceWorker' in navigator){ addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }
</script>
</body>
</html>
